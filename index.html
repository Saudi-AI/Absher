<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title> لوحة معلومات حادث مروري</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
        .card { margin-bottom: 20px; }
        #map { height: 300px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">لوحة معلومات حادث مروري</h1>

    <div class="row">
        <!-- بيانات السيارة -->
        <div class="col-md-6">
            <div class="card p-3">
                <h5>بيانات السيارة</h5>
                <pre id="car-data">لا يوجد بيانات حتى الآن</pre>
            </div>
        </div>
        <!-- GPS -->
        <div class="col-md-6">
            <div class="card p-3">
                <h5>الموقع (GPS)</h5>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- تحليل الضرر -->
        <div class="col-md-6">
            <div class="card p-3">
                <h5>تحليل ذكي لضرر </h5>
                <canvas id="damageChart"></canvas>
            </div>
        </div>
        <!-- فيديو 360 -->
        <div class="col-md-6">
            <div class="card p-3">
                <h5>فيديو 360° للحادث</h5>
                <video id="accident-video" width="100%" controls>
                    <source src="accident360.mp4" type="video/mp4">
                    متصفحك لا يدعم عرض الفيديو
                </video>
            </div>
        </div>
    </div>

    <!-- تقرير الحادث -->
    <div class="card p-3">
        <h5>تقرير الحادث</h5>
        <pre id="report">لا يوجد تقرير بعد</pre>
    </div>

    <!-- أزرار -->
    <button class="btn btn-primary" onclick="simulateCrash()">محاكاة حادث</button>
    <button class="btn btn-success" onclick="sendReport()">إرسال البلاغ</button>
</div>

<script>
    // إعداد خريطة Leaflet
    var map = L.map('map').setView([24.7136, 46.6753], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);
    var marker = L.marker([24.7136, 46.6753]).addTo(map);

    // إعداد Chart.js
    var ctx = document.getElementById('damageChart').getContext('2d');
    var damageChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Front-Left', 'Front-Right', 'Rear-Left', 'Rear-Right'],
            datasets: [{
                label: 'شدة الضرر',
                data: [0, 0, 0, 0],
                backgroundColor: 'rgba(255, 99, 132, 0.6)'
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
    });

    async function simulateCrash() {
        // قراءة بيانات السيارة
        let carRes = await fetch('/scan', {method:'POST'});
        let carData = await carRes.json();
        document.getElementById('car-data').innerText = JSON.stringify(carData.car_data, null, 2);

        // تحليل الضرر
        let aiRes = await fetch('/analyze', {method:'POST'});
        let aiData = await aiRes.json();
        document.getElementById('report').innerText = "جاري توليد التقرير...";

        // تحديث Chart
        let damageValues = [0,0,0,0];
        let idx = ['Front-Left', 'Front-Right', 'Rear-Left', 'Rear-Right'].indexOf(aiData.area);
        damageValues[idx] = aiData.severity === 'Low' ? 30 : aiData.severity === 'Medium' ? 60 : 90;
        damageChart.data.datasets[0].data = damageValues;
        damageChart.update();

        // توليد التقرير
        let reportRes = await fetch('/generate-report', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                owner: carData.car_data.owner,
                plate: carData.car_data.plate,
                car_model: carData.car_data.car_model,
                location: "24.7136,46.6753",
                severity: aiData.severity,
                area: aiData.area
            })
        });
        let reportData = await reportRes.json();
        document.getElementById('report').innerText = reportData.report;
    }

    async function sendReport() {
        let sendRes = await fetch('/send', {method:'POST'});
        let sendData = await sendRes.json();
        alert("تم إرسال البلاغ: " + sendData.status);
    }
</script>
</body>
</html>
